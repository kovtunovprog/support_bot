<!-- template from http://bootsnipp.com/snippets/6eWd -->
<!DOCTYPE html>
<html>
<head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <title></title>

</head>
<body>
<br>
<h1 style="left: 20px; position: absolute; background: #0085EF; border-radius: 5px; padding: 20px; color: white;">Это демо страница виджета</h1>

<div id="chatShowButton">
    <i class="fa fa-comment fa-2x" id="chatShowIcon" aria-hidden="true"></i>
</div>

<div class="" id="chatWidget">

    <div class="" id="chatHeader">
        <span id="backIconContainer"></span>
        <span class="title">Підтримка</span>
        <i class="fa fa-times" id="headerTimesIcon" aria-hidden="true"></i>
    </div>
    <div class="departamentBlock">
        <div class="departamentToggleBlock">
            <span class="depName" id="tehDepartamentToggle">Технічний відділ</span>
        </div>

        <div class="departamentToggleBlock">
            <span class="depName" id="setDepartamentToggle">Відділ врегулювання</span>
        </div>

        <div class="departamentToggleBlock">
            <span class="depName" id="callCenterToggle">Call-центр</span>
        </div>
    </div>

    <div class="chatBlock">
        <div class="chat">
        </div>
        <div class="sendMessageBlock">
            <input id="sendMessageInput" name="userMessage">
            <i class="fa fa-arrow-circle-up fa-2x" id="sendMessageButton"></i>
        </div>
    </div>

</div>

<style>

    #chatShowButton {
        width: 60px;
        height: 60px;
        border-radius: 50px;
        filter: drop-shadow(0px 4px 4px rgba(0, 0, 0, 0.25));
        background: #0085EF;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        position: fixed;
        bottom: 10px;
        right: 10px;
    }

    #chatShowButton #chatShowIcon {
        color: white;
    }

    #chatWidget {
        display: flex;
        flex-direction: column;
        background: #E5E5E5;
        position: fixed;
        bottom: 10px;
        right: 10px;
        width: 380px;
        height: 500px;
        border-radius: 10px;
        filter: drop-shadow(0px 4px 4px rgba(0, 0, 0, 0.25));
    }

    #chatWidget #chatHeader {
        display: inline-flex;
        flex-direction: row;
        display: -webkit-flex; /* Safari */
        align-items: center;
        height: 50px;
        padding: 0 15px 0 15px;
        border-radius: 10px 10px 0 0;
        background: #0085EF;
        color: white;
    }

    #chatWidget #chatHeader #headerTimesIcon {
        margin-left: auto;
        cursor: pointer;
    }

    #chatWidget #chatHeader #headerBackIcon {
        margin-right: 5px;
        cursor: pointer;
    }

    #chatWidget .departamentBlock .departamentToggleBlock {
        display: flex;
        padding: 15px;
        border-bottom: 1px solid #C8C7C7;
    }

    #chatWidget .departamentBlock .departamentToggleBlock .depName {
        cursor: pointer;
        font-size: larger;
    }

    .chatBlock {
        display: flex;
        flex-direction: column;
        justify-content:flex-end;
        height: 450px;
    }

    .chatBlock .chat{
        flex-direction: column;
        flex-grow: 1;
        height: 410px;
        background: #E5E5E5;
        padding: 10px;
        overflow-x: scroll;
    }

    .chatBlock .chat .chatMessage {
        padding: 10px 15px;
        line-height: 16px;
        border-radius:5px;
        display: inline-block;
        margin: 15px 0 0 0;
    }

    .chatBlock .chat .userMessage {
        background: #dbf8ff;
        margin-right: 50px;
    }

    .chatBlock .chat .operatorMessage {
        background: white;
        margin-left: 50px;
        float: right;
    }

    .chatBlock .sendMessageBlock {
        margin-bottom: auto;
        width: 100%;
        display: flex;
        background: white;
        border-radius: 0 0 10px 10px;
    }

    .chatBlock .sendMessageBlock #sendMessageInput {
        display: block;
        width: 320px;
        height: 40px;
        border:none;
        box-shadow:none;
        margin-left: 20px;
    }

    .chatBlock .sendMessageBlock #sendMessageButton {
        height: 30px;
        width: 30px;
        cursor: pointer;
        color: #0085EF;
        align-self: center;
        outline:none;
    }

    .chatBlock, .sendMessageBlock, #sendMessageButton,
    textarea:hover, input:hover, textarea:active,
    input:active, textarea:focus, input:focus, button:focus,
    button:active, button:hover, label:focus,
    .btn:active, .btn.active {
        outline:0 !important;
        -webkit-appearance:none;
    }
    
</style>

<script id="chat_script">
    $(document).ready(function(){
        var web_chat_id = '+38000000000';
        var defaultOperatorMessage = "Добрий день опишіть будь ласка проблему. Ми хочемо Вам допомогти.";
        var domain = document.domain + ':' + location.port;
        var socket = io.connect('http://' +  domain);
        var operator_id;
        var support_group;

        socket.on('operator message', function(data) {
            console.log(data);
            if (checkWebChatId(data.data.web_chat_id)) {
                console.log(data);
                addMessageToChat(data.data.message, 'operator');
                if (data.data.connection === 'closed') {
                    closeConnection();
                    closeChat();
                }
            }
        });

        function checkWebChatId(server_chat_id) {
            return server_chat_id === web_chat_id;
        }
        
        // function start_connection() {
        //     socket = io.connect('http://' +  domain);
        // }
        
        function closeConnection() {
            socket.emit('close', {
                data: {'web_chat_id': web_chat_id}
            });
        }

        function sendUserMessageToServer(chat_id, msg, full_name=null) {
            var data = {
                "chat_id": chat_id,
                "full_name": full_name,
                "message": msg,
                'support_group': support_group
            };
            console.log(data);
            socket.emit('user message', {
                data: data
            });
        }

        // Загрузка по умолчанию
        function loadDefault() {
            $("#chatWidget").hide();
            $(".chatBlock").hide();
        }

        loadDefault();

        // Обрабатывает нажатие на кнопу #chatShowButton
        function chatShowButton() {
            $("#chatShowButton").hide();
            $("#chatWidget").show();
        }

        // Обрабатывает нажатие на кнопку #headerTimesIcon
        function closeChat() {
            $(".chatBlock").hide();
            $( "#headerBackIcon" ).remove();
            $(".departamentBlock").show();
            $(".title").text("Піддтримка");
            $(".operatorMessage").remove();
            $(".userMessage").remove();
            $(".chatIdent").remove();
            $("#chatWidget").hide();
            $('#chatShowButton').show();
            support_group = 0;
            socket.emit('close', {
                data: {'web_chat_id': web_chat_id}
            });
        }

        // Показать чат (при нажатии на кнопку с департаментами)
        function showChat(dep_name) {
            $(".departamentBlock").hide();
            $(".chatBlock").show();
            $(".title").text(dep_name);
            $( "#backIconContainer" )
                .append("<i class=\"fa fa-arrow-circle-left\" id=\"headerBackIcon\" aria-hidden=\"true\"></i>");
            setTimeout(sendDefaultMessage, 1000);
        }

        // Спрятать блок департаментов
        function hideTehDep() {
            var dep_name = "Технічний відділ";
            showChat(dep_name);
            support_group = 1;
        }

        function hideSetDep() {
            var dep_name = "Відділ врегулювання";
            showChat(dep_name);
            support_group = 2;

        }

        function hideCallDep() {
            var dep_name = "Call-центр";
            showChat(dep_name);
            support_group = 3;
        }

        // Обрабатывает нажатие на кнопку "обратно"
        function backDep() {
            $(".chatBlock").hide();
            $(".departamentBlock").show();
            $( "#headerBackIcon" ).remove();
            $(".title").text("Піддтримка");
            $(".operatorMessage").remove();
            $(".userMessage").remove();
            $(".chatIdent").remove();
            support_group = 0;
            socket.emit('close', {
                data: {'web_chat_id': web_chat_id}
            });
        }

        // Добавление сообщения в чат
        function addMessageToChat(message, sender) {
            $(".chat").append("<div class=\"chatMessage " + sender + "Message\">" + message + "</div></div><br class=\"chatIdent\">")
                .scrollTop($(".chat").height());
            $("#sendMessageInput").val("");
        }

        // Обработка нажатия enter
        function sendMessageFromEnter(event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '13'){
                var message = $(this).val();
                if (message != "") {
                    addMessageToChat(message, "user");
                    sendUserMessageToServer(web_chat_id, message);
                }
            }
            event.stopPropagation();
        }

        // Обработка нажатия на кнопку
        function sendMessageFromButton() {
            var message = $("#sendMessageInput").val();
            if (message != "") {
                addMessageToChat(message, "user");
                sendUserMessageToServer(web_chat_id, message)
            }
        }

        // Сообщение оператора по умолчанию
        function sendDefaultMessage() {
            addMessageToChat(defaultOperatorMessage, 'operator')
        }

        $("#chatShowButton").click(chatShowButton);
        $("#headerTimesIcon").click(closeChat);
        $("#tehDepartamentToggle").click(hideTehDep);
        $("#setDepartamentToggle").click(hideSetDep);
        $("#callCenterToggle").click(hideCallDep);
        $("#backIconContainer").click(backDep);
        $("#sendMessageInput").keypress(sendMessageFromEnter);
        $("#sendMessageButton").click(sendMessageFromButton);

    });

</script>


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
</body>
</html>
